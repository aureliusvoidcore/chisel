# ChiselForge Integration Summary

## Overview
This document details the integration of the **Surfer** VCD viewer and a filesystem browser into the ChiselForge IDE. These features allow users to visualize waveform traces generated by the verification tools (EBMC/CVC5) directly within the browser.

## 1. Surfer VCD Viewer Integration
We integrated [Surfer](https://gitlab.com/surfer-project/surfer), a high-performance waveform viewer written in Rust and compiled to WebAssembly (WASM).

### Implementation Details
- **Build Process**: Built Surfer from source using `trunk` and `wasm-pack` with the `wasm32-unknown-unknown` target.
- **Assets**: The compiled artifacts (`index.html`, `surfer.js`, `surfer_bg.wasm`, etc.) are hosted in `public/surfer/`.
- **Component**: Created `src/components/SurferViewer.jsx` to embed the viewer via an `iframe`.
- **Communication**: The viewer loads VCD files via a `load_url` query parameter. We updated the component to construct correct URLs using the current origin to avoid CORS issues.

## 2. Filesystem Browser
We added a sidebar component to browse files generated by the backend (e.g., SystemVerilog, VCD traces).

### Implementation Details
- **Component**: Created `src/components/FileSystem.jsx`.
- **API**: The component fetches the file list from `/api/fs/list`.
- **Interaction**: 
    - Clicking a file name selects it (logic prepared for future file editing).
    - Clicking the **Eye icon** next to a `.vcd` file triggers the `handleFileSelect` in `App.jsx`, switching the view to the Waveform tab.

## 3. Backend Updates (`server/server.js`)
The Node.js backend was updated to support the new frontend features.

- **Static File Serving**: Added `app.use('/api/files', express.static(CHISEL_GENERATED))` to serve generated files to the frontend and the Surfer viewer.
- **Directory Listing**: Added `app.get('/api/fs/list', ...)` to recursively list files in the `generated` directory.

## 4. Frontend Architecture (`src/App.jsx`)
The main application layout was modified to accommodate the new tools.

- **Tabs**: Added a "Files" tab to the left sidebar.
- **View Switcher**: Added a "Code / Waveform" toggle in the top toolbar.
- **State Management**: Added `currentVcdUrl` and `viewMode` state variables.
- **Automation**: When verification succeeds and produces a VCD, the IDE automatically switches to the Waveform view.

## 5. Configuration & Fixes
- **Vite Proxy**: Updated `vite.config.js` to proxy `/api` requests to `http://localhost:3001`. This resolves CORS issues during development and ensures the frontend can talk to the backend seamlessly.
- **Surfer Assets Fix**: Modified `public/surfer/index.html` to use relative paths (`./`) for loading the WASM and JS files, ensuring it works when served from a subdirectory.
- **Event Handling**: Fixed an issue where clicking the "Eye" icon in the file list did not trigger the view switch by adding explicit `stopPropagation` and click handlers.

## Files Changed/Created
- `src/components/SurferViewer.jsx` (New)
- `src/components/FileSystem.jsx` (New)
- `public/surfer/*` (New assets)
- `server/server.js` (Modified)
- `src/App.jsx` (Modified)
- `vite.config.js` (Modified)
