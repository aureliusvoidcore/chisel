// Mock Chisel Compiler - Generic Mode
// This script simulates the Chisel compiler interface.
// Since the real Scala.js artifact is not available, this uses regex to parse basic module info
// and generate valid "skeleton" artifacts to prove the data flow works.

self.ChiselCompiler = {
  getFirtoolOptions: function(moduleName, configJson) {
    const outputDir = `generated/${moduleName}`;
    return `-o=${outputDir}/${moduleName}.sv --verification-flavor=sva --strip-fir-debug-info`;
  },

  elaborate: function(moduleName, code) {
    console.log(`[MockCompiler] Elaborating ${moduleName}...`);
    
    // 1. Detect Module Name
    const classMatch = code ? code.match(/class\s+(\w+)/) : null;
    const detectedName = classMatch ? classMatch[1] : moduleName;

    // 2. Generate Skeleton FIRRTL
    return `FIRRTL version 3.1.0
circuit ${detectedName} :
  module ${detectedName} :
    input clock : Clock
    input reset : UInt<1>
    ; This is a skeleton FIRRTL generated by the generic mock compiler.
    ; Real Chisel compilation requires the full Scala.js artifact.
`;
  },

  generateVerilog: function(moduleName, code) {
     // 1. Detect Module Name
     const classMatch = code ? code.match(/class\s+(\w+)/) : null;
     const detectedName = classMatch ? classMatch[1] : moduleName;

     // 2. Detect IOs (Very basic regex heuristic)
     // Looks for val io = IO(...) and tries to find Input/Output fields
     const ioBlockMatch = code ? code.match(/val\s+io\s*=\s*IO\s*\(([\s\S]*?)\}\)/) : null;
     let ports = [
        "input clock",
        "input reset"
     ];

     if (ioBlockMatch) {
        const ioBody = ioBlockMatch[1];
        const lines = ioBody.split('\n');
        lines.forEach(line => {
            const inputMatch = line.match(/val\s+(\w+)\s*=\s*Input\(/);
            const outputMatch = line.match(/val\s+(\w+)\s*=\s*Output\(/);
            if (inputMatch) ports.push(`input ${inputMatch[1]}`);
            if (outputMatch) ports.push(`output ${outputMatch[1]}`);
        });
     }

     // 3. Generate Skeleton Verilog
     const portString = ports.join(',\n  ');

     return `module ${detectedName}(
  ${portString}
);
  // This is a skeleton SystemVerilog module generated by the generic mock compiler.
  // It proves that the UI correctly passes code to the worker and receives this result.
  
  // To enable real compilation, you must build the 'chisel-sandbox-fastopt.js' 
  // using 'sbt fastLinkJS' and place it in public/bin/.

endmodule`;
  }
};
